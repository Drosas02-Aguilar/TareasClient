<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Mis Tareas - TaskFlow</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
        <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: 'Poppins', sans-serif;
                background: #f0f2f5;
                min-height: 100vh;
            }

            /* Navbar */
            .navbar-custom {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
                padding: 15px 0;
            }

            .navbar-brand {
                font-size: 24px;
                font-weight: 700;
                color: white !important;
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .brand-icon {
                width: 40px;
                height: 40px;
                background: rgba(255, 255, 255, 0.2);
                border-radius: 10px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .nav-link {
                color: rgba(255, 255, 255, 0.9) !important;
                font-weight: 500;
                padding: 8px 15px !important;
                border-radius: 8px;
                transition: all 0.3s ease;
            }

            .nav-link:hover {
                background: rgba(255, 255, 255, 0.2);
                color: white !important;
            }

            .user-badge {
                background: rgba(255, 255, 255, 0.2);
                padding: 8px 15px;
                border-radius: 20px;
                color: white;
                font-weight: 500;
                text-decoration: none;
                display: inline-flex;
                align-items: center;
                gap: 8px;
                transition: all 0.3s ease;
                cursor: pointer;
            }

            .user-badge:hover {
                background: rgba(255, 255, 255, 0.3);
                color: white;
                transform: translateY(-1px);
            }

            /* Main Content */
            .main-content {
                padding: 40px 0;
            }

            .page-header {
                background: white;
                border-radius: 20px;
                padding: 30px;
                margin-bottom: 30px;
                box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
            }

            .page-title {
                font-size: 32px;
                font-weight: 700;
                color: #2d3748;
                margin: 0;
            }

            .page-subtitle {
                color: #6c757d;
                margin: 0;
            }

            .btn-new-task {
                padding: 12px 25px;
                font-size: 15px;
                font-weight: 600;
                border: none;
                border-radius: 12px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                transition: all 0.3s ease;
                box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
                text-decoration: none;
                display: inline-flex;
                align-items: center;
                gap: 8px;
            }

            .btn-new-task:hover {
                transform: translateY(-2px);
                box-shadow: 0 12px 30px rgba(102, 126, 234, 0.4);
                color: white;
            }

            /* Stats Cards */
            .stats-container {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 20px;
                margin-bottom: 30px;
            }

            .stat-card {
                background: white;
                border-radius: 15px;
                padding: 25px;
                box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
                transition: all 0.3s ease;
                animation: slideUp 0.6s ease-out;
            }

            .stat-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            }

            @keyframes slideUp {
                from {
                    opacity: 0;
                    transform: translateY(30px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .stat-icon {
                width: 50px;
                height: 50px;
                border-radius: 12px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 24px;
                color: white;
                margin-bottom: 15px;
            }

            .stat-icon.total {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            }

            .stat-icon.pending {
                background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            }

            .stat-icon.completed {
                background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            }

            .stat-value {
                font-size: 32px;
                font-weight: 700;
                color: #2d3748;
                margin: 0;
            }

            .stat-label {
                color: #6c757d;
                font-size: 14px;
                margin: 0;
            }

            /* Task Card */
            .task-card {
                background: white;
                border-radius: 15px;
                padding: 20px;
                margin-bottom: 15px;
                box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
                transition: all 0.3s ease;
                animation: slideUp 0.6s ease-out;
                opacity: 0;
            }

            .task-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            }

            .task-header {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                margin-bottom: 15px;
            }

            .task-title {
                font-size: 18px;
                font-weight: 600;
                color: #2d3748;
                margin: 0 0 5px 0;
            }

            .task-description {
                color: #6c757d;
                font-size: 14px;
                margin: 0;
            }

            .task-badge {
                padding: 6px 12px;
                border-radius: 20px;
                font-size: 12px;
                font-weight: 600;
                cursor: pointer;
                user-select: none;
                transition: all 0.3s ease;
            }

            .task-badge:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            }

            .badge-iniciada {
                background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
                color: #1565c0;
            }

            .badge-pendiente {
                background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
                color: #e65100;
            }

            .badge-completada {
                background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
                color: #2e7d32;
            }

            /* Dropdown Styles */
            .dropdown-toggle::after {
                vertical-align: middle;
                margin-left: 5px;
            }

            .dropdown-menu {
                border-radius: 12px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
                border: none;
                padding: 8px;
                min-width: 180px;
            }

            .dropdown-item {
                border-radius: 8px;
                padding: 10px 15px;
                font-size: 14px;
                font-weight: 600;
                transition: all 0.3s ease;
                display: flex;
                align-items: center;
            }

            .dropdown-item:hover {
                background: #f8f9fa;
                transform: translateX(5px);
            }

            .dropdown-item:active {
                background: #e9ecef;
            }

            .dropdown-item i {
                font-size: 16px;
            }

            .task-footer {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-top: 15px;
                padding-top: 15px;
                border-top: 1px solid #e9ecef;
            }

            .task-date {
                color: #6c757d;
                font-size: 14px;
                display: flex;
                align-items: center;
                gap: 5px;
            }

            .task-actions {
                display: flex;
                gap: 8px;
            }

            .btn-action {
                width: 35px;
                height: 35px;
                border: none;
                border-radius: 8px;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.3s ease;
                cursor: pointer;
            }

            .btn-view {
                background: #e3f2fd;
                color: #1976d2;
            }

            .btn-view:hover {
                background: #1976d2;
                color: white;
            }

            .btn-edit {
                background: #fff3e0;
                color: #f57c00;
            }

            .btn-edit:hover {
                background: #f57c00;
                color: white;
            }

            .btn-delete {
                background: #ffebee;
                color: #d32f2f;
            }

            .btn-delete:hover {
                background: #d32f2f;
                color: white;
            }

            .empty-state {
                text-align: center;
                padding: 60px 20px;
                background: white;
                border-radius: 20px;
                box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
            }

            .empty-icon {
                font-size: 80px;
                color: #e9ecef;
                margin-bottom: 20px;
            }

            .empty-title {
                font-size: 24px;
                font-weight: 600;
                color: #2d3748;
                margin-bottom: 10px;
            }

            .empty-text {
                color: #6c757d;
                margin-bottom: 30px;
            }

            /* Toast Notifications */
            .toast {
                min-width: 300px;
                border-radius: 12px;
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
                animation: slideInRight 0.4s ease-out;
            }
            
            @keyframes slideInRight {
                from {
                    opacity: 0;
                    transform: translateX(100%);
                }
                to {
                    opacity: 1;
                    transform: translateX(0);
                }
            }
            
            .toast.toast-success {
                background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            }
            
            .toast.toast-error {
                background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            }
            
            .toast.toast-info {
                background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            }
            
            .toast-body {
                padding: 15px 20px;
                font-size: 15px;
                font-weight: 500;
            }

            /* Estilos para el modal de detalle */
            .modal-content {
                border-radius: 15px;
                border: none;
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            }

            .modal-header {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border-radius: 15px 15px 0 0;
                padding: 20px 25px;
            }

            .modal-header .btn-close {
                filter: brightness(0) invert(1);
            }

            .modal-title {
                font-size: 20px;
            }

            .modal-body {
                padding: 25px;
            }

            #modal-estado-badge.badge-iniciada {
                background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
                color: #1565c0;
            }

            #modal-estado-badge.badge-pendiente {
                background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
                color: #e65100;
            }

            #modal-estado-badge.badge-completada {
                background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
                color: #2e7d32;
            }

            .timeline-container {
                position: relative;
            }

            .timeline-container::before {
                content: '';
                position: absolute;
                left: 5px;
                top: 12px;
                bottom: 12px;
                width: 2px;
                background: #e9ecef;
            }

            @media (max-width: 768px) {
                .task-header {
                    flex-direction: column;
                    gap: 10px;
                }

                .task-footer {
                    flex-direction: column;
                    gap: 10px;
                    align-items: flex-start;
                }
            }
        </style>
    </head>
    <body>
        <!-- Navbar -->
        <nav class="navbar navbar-expand-lg navbar-custom">
            <div class="container-fluid px-4">
                <a class="navbar-brand" th:href="@{/dashboard}">
                    <div class="brand-icon">
                        <i class="bi bi-check2-circle"></i>
                    </div>
                    TaskFlow
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto align-items-center">
                        <li class="nav-item me-2">
                            <a th:href="@{/usuario/perfil}" class="user-badge">
                                <i class="bi bi-person-circle"></i>
                                <span th:text="${username}"></span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" th:href="@{/auth/logout}">
                                <i class="bi bi-box-arrow-right me-1"></i> Salir
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="main-content">
            <div class="container">
                <!-- Page Header -->
                <div class="page-header">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                        <div>
                            <h1 class="page-title">Mis Tareas</h1>
                            <p class="page-subtitle">Gestiona y organiza tus actividades</p>
                        </div>
                        <a th:href="@{/tareas/nueva}" class="btn-new-task">
                            <i class="bi bi-plus-circle"></i>
                            Nueva Tarea
                        </a>
                    </div>
                </div>

                <!-- Stats -->
                <div class="stats-container">
                    <div class="stat-card">
                        <div class="stat-icon total">
                            <i class="bi bi-list-task"></i>
                        </div>
                        <h3 class="stat-value" th:text="${tareas != null ? tareas.size() : 0}">0</h3>
                        <p class="stat-label">Total de Tareas</p>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon pending">
                            <i class="bi bi-clock-history"></i>
                        </div>
                        <h3 class="stat-value" id="stat-pending">0</h3>
                        <p class="stat-label">Pendientes</p>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon completed">
                            <i class="bi bi-check-circle"></i>
                        </div>
                        <h3 class="stat-value" id="stat-completed">0</h3>
                        <p class="stat-label">Completadas</p>
                    </div>
                </div>

                <!-- Tasks List -->
                <div th:if="${tareas != null and !tareas.isEmpty()}">
                    <div th:each="tarea, iterStat : ${tareas}" class="task-card" th:data-index="${iterStat.index}">
                        <div class="task-header">
                            <div>
                                <h3 class="task-title" th:text="${tarea.titulo}">Título de la tarea</h3>
                                <p class="task-description" th:text="${tarea.descripcion}">Descripción</p>
                            </div>
                            
                            <!-- Dropdown para cambiar estado -->
                            <div class="dropdown">
                                <span class="task-badge dropdown-toggle" 
                                      th:classappend="${tarea.estado.toString() == 'INICIADA'} ? 'badge-iniciada' : 
                                      (${tarea.estado.toString() == 'PENDIENTE'} ? 'badge-pendiente' : 'badge-completada')"
                                      data-bs-toggle="dropdown"
                                      aria-expanded="false"
                                      th:data-id="${tarea.idTarea}"
                                      th:attr="data-estado-actual=${tarea.estado}">
                                    <span th:text="${tarea.estado}">Estado</span>
                                </span>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li>
                                        <a class="dropdown-item cambiar-estado" 
                                           href="#"
                                           th:data-id="${tarea.idTarea}"
                                           data-estado="PENDIENTE">
                                            <i class="bi bi-clock me-2" style="color: #e65100;"></i>
                                            PENDIENTE
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item cambiar-estado" 
                                           href="#"
                                           th:data-id="${tarea.idTarea}"
                                           data-estado="INICIADA">
                                            <i class="bi bi-hourglass-split me-2" style="color: #1565c0;"></i>
                                            INICIADA
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item cambiar-estado" 
                                           href="#"
                                           th:data-id="${tarea.idTarea}"
                                           data-estado="COMPLETADA">
                                            <i class="bi bi-check-circle me-2" style="color: #2e7d32;"></i>
                                            COMPLETADA
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </div>

                        <div class="task-footer">
                            <div class="task-date">
                                <i class="bi bi-calendar-event"></i>
                                <span th:text="${tarea.fechafin}">Fecha</span>
                            </div>

                            <div class="task-actions">
                                <button type="button" 
                                        class="btn-action btn-view btn-ver-detalle" 
                                        th:data-id="${tarea.idTarea}"
                                        th:data-titulo="${tarea.titulo}"
                                        th:data-descripcion="${tarea.descripcion}"
                                        th:data-estado="${tarea.estado}"
                                        th:data-fecha="${tarea.fechafin}"
                                        title="Ver detalle">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <a th:href="@{/tareas/editar/{id}(id=${tarea.idTarea})}" 
                                   class="btn-action btn-edit" 
                                   title="Editar">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                <form th:action="@{/tareas/eliminar/{id}(id=${tarea.idTarea})}" 
                                      method="post" 
                                      style="display: inline;"
                                      class="delete-form">
                                    <button type="submit" 
                                            class="btn-action btn-delete" 
                                            title="Eliminar"
                                            onclick="return confirm('¿Estás seguro de eliminar esta tarea?')">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Empty State -->
                <div th:if="${tareas == null or tareas.isEmpty()}" class="empty-state">
                    <div class="empty-icon">
                        <i class="bi bi-clipboard-x"></i>
                    </div>
                    <h2 class="empty-title">No tienes tareas</h2>
                    <p class="empty-text">Comienza creando tu primera tarea y organiza tu día</p>
                    <a th:href="@{/tareas/nueva}" class="btn-new-task">
                        <i class="bi bi-plus-circle"></i>
                        Crear Primera Tarea
                    </a>
                </div>
            </div>
        </div>

        <!-- Modal de Detalle de Tarea -->
        <div class="modal fade" id="detalleModal" tabindex="-1" aria-labelledby="detalleModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content">
                    <div class="modal-header border-0">
                        <h5 class="modal-title fw-bold" id="detalleModalLabel">
                            <i class="bi bi-info-circle me-2"></i>
                            Detalle de Tarea
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Título -->
                        <div class="mb-4">
                            <h3 class="fw-bold text-dark mb-2" id="modal-titulo">Título de la tarea</h3>
                            <span class="badge rounded-pill fs-6 px-3 py-2" id="modal-estado-badge">
                                <i class="bi bi-clock-fill me-1"></i>
                                <span id="modal-estado">PENDIENTE</span>
                            </span>
                        </div>

                        <!-- Info Cards -->
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <div class="p-3 bg-light rounded-3">
                                    <div class="d-flex align-items-center mb-2">
                                        <div class="rounded-circle bg-success bg-opacity-10 p-2 me-2">
                                            <i class="bi bi-calendar-event text-success"></i>
                                        </div>
                                        <small class="text-muted text-uppercase">Fecha Fin</small>
                                    </div>
                                    <p class="fw-semibold mb-0" id="modal-fecha">01/01/2024</p>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="p-3 bg-light rounded-3">
                                    <div class="d-flex align-items-center mb-2">
                                        <div class="rounded-circle bg-warning bg-opacity-10 p-2 me-2">
                                            <i class="bi bi-flag-fill text-warning"></i>
                                        </div>
                                        <small class="text-muted text-uppercase">Estado</small>
                                    </div>
                                    <p class="fw-semibold mb-0" id="modal-estado-text">PENDIENTE</p>
                                </div>
                            </div>
                        </div>

                        <!-- Descripción -->
                        <div class="mb-4">
                            <h6 class="fw-semibold mb-2">
                                <i class="bi bi-text-paragraph me-2"></i>
                                Descripción
                            </h6>
                            <div class="p-3 bg-light rounded-3">
                                <p class="mb-0 text-muted" id="modal-descripcion">
                                    Sin descripción
                                </p>
                            </div>
                        </div>

                        <!-- Timeline -->
                        <div class="mb-3">
                            <h6 class="fw-semibold mb-3">
                                <i class="bi bi-clock-history me-2"></i>
                                Información Adicional
                            </h6>
                            <div class="timeline-container">
                                <div class="d-flex mb-3">
                                    <div class="me-3">
                                        <div class="rounded-circle bg-primary" style="width: 12px; height: 12px; margin-top: 4px;"></div>
                                    </div>
                                    <div class="flex-grow-1">
                                        <p class="fw-semibold mb-1">Fecha límite</p>
                                        <p class="text-muted small mb-0" id="modal-fecha-limite">
                                            Completar antes del 01/01/2024
                                        </p>
                                    </div>
                                </div>

                                <div class="d-flex" id="modal-estado-timeline">
                                    <div class="me-3">
                                        <div class="rounded-circle" style="width: 12px; height: 12px; margin-top: 4px;" id="timeline-dot"></div>
                                    </div>
                                    <div class="flex-grow-1">
                                        <p class="fw-semibold mb-1">Estado</p>
                                        <p class="small mb-0" id="modal-estado-mensaje">
                                            <i class="bi bi-hourglass-split me-1"></i>
                                            Tarea pendiente de completar
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer border-0 pt-0">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle me-1"></i>
                            Cerrar
                        </button>
                        <button type="button" class="btn btn-primary" id="btn-editar-modal">
                            <i class="bi bi-pencil me-1"></i>
                            Editar
                        </button>
                        <button type="button" class="btn btn-danger" id="btn-eliminar-modal">
                            <i class="bi bi-trash me-1"></i>
                            Eliminar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Toast Container -->
        <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;">
            <div id="successToast" class="toast align-items-center text-white border-0" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="bi bi-check-circle-fill me-2"></i>
                        <span id="toastMessage"></span>
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        </div>

        <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script th:inline="javascript">
            $(document).ready(function () {
                // Función para mostrar toast
                function showToast(message, type = 'success') {
                    const toast = $('#successToast');
                    const toastBody = toast.find('.toast-body');
                    
                    toast.removeClass('toast-success toast-error toast-info');
                    
                    if (type === 'success') {
                        toast.addClass('toast-success');
                        toastBody.html('<i class="bi bi-check-circle-fill me-2"></i><span>' + message + '</span>');
                    } else if (type === 'error') {
                        toast.addClass('toast-error');
                        toastBody.html('<i class="bi bi-exclamation-circle-fill me-2"></i><span>' + message + '</span>');
                    } else if (type === 'info') {
                        toast.addClass('toast-info');
                        toastBody.html('<i class="bi bi-info-circle-fill me-2"></i><span>' + message + '</span>');
                    }
                    
                    const bsToast = new bootstrap.Toast(toast[0], {
                        autohide: true,
                        delay: 4000
                    });
                    bsToast.show();
                }
                
                const successMsg = /*[[${success}]]*/ null;
                const errorMsg = /*[[${error}]]*/ null;
                const infoMsg = /*[[${info}]]*/ null;
                
                if (successMsg) {
                    showToast(successMsg, 'success');
                }
                if (errorMsg) {
                    showToast(errorMsg, 'error');
                }
                if (infoMsg) {
                    showToast(infoMsg, 'info');
                }
                
                $('.task-card').each(function (index) {
                    $(this).delay(index * 100).animate({'opacity': '1'}, 400);
                });

                function actualizarEstadisticas() {
                    let pending = 0;
                    let completed = 0;

                    $('.task-badge span').each(function () {
                        const estado = $(this).text().trim();
                        if (estado === 'PENDIENTE' || estado === 'INICIADA') {
                            pending++;
                        } else if (estado === 'COMPLETADA') {
                            completed++;
                        }
                    });

                    $('#stat-pending').text(pending);
                    $('#stat-completed').text(completed);
                }
                
                actualizarEstadisticas();

                const token = /*[[${session.token}]]*/ '';
                const idUsuario = /*[[${session.idUsuario}]]*/ '';

                function limpiarDropdowns() {
                    $('.dropdown-menu').removeClass('show');
                    $('.dropdown').removeClass('show');
                    $('.task-badge').attr('aria-expanded', 'false');
                    
                    $('.dropdown-backdrop').remove();
                    $('body').removeClass('dropdown-open');
                    
                    $('.task-badge').each(function() {
                        const instance = bootstrap.Dropdown.getInstance(this);
                        if (instance) {
                            instance.dispose();
                        }
                    });
                    
                    $('.task-badge').each(function() {
                        new bootstrap.Dropdown(this);
                    });
                }

                $(document).on('click', '.cambiar-estado', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const idTarea = $(this).data('id');
                    const nuevoEstado = $(this).data('estado');
                    const dropdownElement = $(this).closest('.dropdown');
                    const badge = dropdownElement.find('.task-badge');
                    
                    const estadoActual = badge.attr('data-estado-actual');
                    
                    if (nuevoEstado === estadoActual) {
                        limpiarDropdowns();
                        return;
                    }
                    
                    limpiarDropdowns();
                    
                    $.ajax({
                        url: `http://localhost:8080/api/tareas/usuario/${idUsuario}/${idTarea}/estado`,
                        type: 'PATCH',
                        contentType: 'application/json',
                        headers: {
                            'Authorization': 'Bearer ' + token
                        },
                        data: JSON.stringify({ estado: nuevoEstado }),
                        success: function(response) {
                            if (response.correct || response.status === 200) {
                                showToast('Estado actualizado a ' + nuevoEstado, 'success');
                                
                                badge.removeClass('badge-iniciada badge-pendiente badge-completada');
                                
                                badge.attr('data-estado-actual', nuevoEstado);
                                badge.data('estado-actual', nuevoEstado);
                                
                                badge.find('span').text(nuevoEstado);
                                
                                if (nuevoEstado === 'INICIADA') {
                                    badge.addClass('badge-iniciada');
                                } else if (nuevoEstado === 'PENDIENTE') {
                                    badge.addClass('badge-pendiente');
                                } else if (nuevoEstado === 'COMPLETADA') {
                                    badge.addClass('badge-completada');
                                }
                                
                                const taskCard = badge.closest('.task-card');
                                taskCard.find('.btn-ver-detalle').attr('data-estado', nuevoEstado);
                                
                                actualizarEstadisticas();
                                
                                setTimeout(function() {
                                    limpiarDropdowns();
                                }, 200);
                                
                            } else {
                                showToast(response.errorMessage || 'Error al actualizar el estado', 'error');
                                limpiarDropdowns();
                            }
                        },
                        error: function(xhr, status, error) {
                            let errorMessage = 'Error al actualizar el estado';
                            
                            if (xhr.responseJSON && xhr.responseJSON.errorMessage) {
                                errorMessage = xhr.responseJSON.errorMessage;
                            } else if (xhr.status === 404) {
                                errorMessage = 'Tarea no encontrada';
                            } else if (xhr.status === 403) {
                                errorMessage = 'No tienes permisos para realizar esta acción';
                            } else if (xhr.status === 401) {
                                errorMessage = 'Sesión expirada. Inicia sesión nuevamente';
                                setTimeout(() => {
                                    window.location.href = '/auth/login';
                                }, 2000);
                            }
                            
                            showToast(errorMessage, 'error');
                            limpiarDropdowns();
                        }
                    });
                });

                setTimeout(function() {
                    $('.task-badge').each(function() {
                        new bootstrap.Dropdown(this);
                    });
                }, 100);

                $(document).on('click', function(e) {
                    if (!$(e.target).closest('.dropdown').length && !$(e.target).hasClass('cambiar-estado')) {
                        limpiarDropdowns();
                    }
                });

                $(document).on('click', '.task-badge', function(e) {
                    if ($(this).attr('aria-expanded') === 'true') {
                        e.stopPropagation();
                    }
                });

                $(document).on('click', '.btn-ver-detalle', function () {
                    const id = $(this).data('id');
                    const titulo = $(this).data('titulo');
                    let descripcion = $(this).data('descripcion');
                    const taskCard = $(this).closest('.task-card');
                    const estado = taskCard.find('.task-badge span').text().trim();
                    const fecha = $(this).data('fecha');

                    if (!descripcion || descripcion === 'null' || descripcion.trim() === '') {
                        descripcion = 'Sin descripción';
                    }

                    $('#modal-titulo').text(titulo);
                    $('#modal-fecha').text(fecha);
                    $('#modal-descripcion').text(descripcion);
                    $('#modal-estado').text(estado);
                    $('#modal-estado-text').text(estado);
                    $('#modal-fecha-limite').text('Completar antes del ' + fecha);

                    const badge = $('#modal-estado-badge');
                    badge.removeClass('badge-iniciada badge-pendiente badge-completada');

                    if (estado === 'INICIADA') {
                        badge.addClass('badge-iniciada');
                        badge.find('i').attr('class', 'bi bi-clock-fill me-1');
                    } else if (estado === 'PENDIENTE') {
                        badge.addClass('badge-pendiente');
                        badge.find('i').attr('class', 'bi bi-clock-fill me-1');
                    } else if (estado === 'COMPLETADA') {
                        badge.addClass('badge-completada');
                        badge.find('i').attr('class', 'bi bi-check-circle-fill me-1');
                    }

                    const timelineDot = $('#timeline-dot');
                    const estadoMensaje = $('#modal-estado-mensaje');

                    if (estado === 'COMPLETADA') {
                        timelineDot.removeClass('bg-warning').addClass('bg-success');
                        estadoMensaje.html('<i class="bi bi-check-circle-fill text-success me-1"></i> Tarea completada exitosamente');
                        estadoMensaje.removeClass('text-muted').addClass('text-success');
                    } else {
                        timelineDot.removeClass('bg-success').addClass('bg-warning');
                        estadoMensaje.html('<i class="bi bi-hourglass-split text-warning me-1"></i> Tarea pendiente de completar');
                        estadoMensaje.removeClass('text-success').addClass('text-muted');
                    }

                    $('#btn-editar-modal').off('click').on('click', function () {
                        window.location.href = '/tareas/editar/' + id;
                    });

                    $('#btn-eliminar-modal').off('click').on('click', function () {
                        if (confirm('¿Estás seguro de eliminar esta tarea?')) {
                            const form = $('<form>', {
                                'method': 'POST',
                                'action': '/tareas/eliminar/' + id
                            });
                            $('body').append(form);
                            form.submit();
                        }
                    });

                    $('#detalleModal').modal('show');
                });
            });
        </script>
    </body>
</html>
