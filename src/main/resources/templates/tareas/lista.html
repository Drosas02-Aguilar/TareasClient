<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Mis Tareas - TaskFlow</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
        <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: 'Poppins', sans-serif;
                background: #f0f2f5;
                min-height: 100vh;
            }

            /* Navbar */
            .navbar-custom {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
                padding: 15px 0;
            }

            .navbar-brand {
                font-size: 24px;
                font-weight: 700;
                color: white !important;
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .brand-icon {
                width: 40px;
                height: 40px;
                background: rgba(255, 255, 255, 0.2);
                border-radius: 10px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .nav-link {
                color: rgba(255, 255, 255, 0.9) !important;
                font-weight: 500;
                padding: 8px 15px !important;
                border-radius: 8px;
                transition: all 0.3s ease;
            }

            .nav-link:hover {
                background: rgba(255, 255, 255, 0.2);
                color: white !important;
            }

            .user-badge {
                background: rgba(255, 255, 255, 0.2);
                padding: 8px 15px;
                border-radius: 20px;
                color: white;
                font-weight: 500;
                text-decoration: none;
                display: inline-flex;
                align-items: center;
                gap: 8px;
                transition: all 0.3s ease;
                cursor: pointer;
            }

            .user-badge:hover {
                background: rgba(255, 255, 255, 0.3);
                color: white;
                transform: translateY(-1px);
            }

            /* Main Content */
            .main-content {
                padding: 40px 0;
            }

            .page-header {
                background: white;
                border-radius: 20px;
                padding: 30px;
                margin-bottom: 30px;
                box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
            }

            .page-title {
                font-size: 32px;
                font-weight: 700;
                color: #2d3748;
                margin: 0;
            }

            .page-subtitle {
                color: #6c757d;
                margin: 0;
            }

            .btn-new-task {
                padding: 12px 25px;
                font-size: 15px;
                font-weight: 600;
                border: none;
                border-radius: 12px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                transition: all 0.3s ease;
                box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
                text-decoration: none;
                display: inline-flex;
                align-items: center;
                gap: 8px;
            }

            .btn-new-task:hover {
                transform: translateY(-2px);
                box-shadow: 0 12px 30px rgba(102, 126, 234, 0.4);
                color: white;
            }

            /* Filtros Container */
            .filters-container {
                background: white;
                border-radius: 15px;
                padding: 25px;
                box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
                animation: slideUp 0.5s ease-out;
            }

            .filter-label {
                font-size: 13px;
                font-weight: 600;
                color: #6c757d;
                margin-bottom: 8px;
                display: block;
            }

            .filter-select, .filter-input {
                border: 2px solid #e9ecef;
                border-radius: 10px;
                padding: 10px 15px;
                font-size: 14px;
                transition: all 0.3s ease;
                background: #f8f9fa;
            }

            .filter-select:focus, .filter-input:focus {
                border-color: #667eea;
                box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
                background: white;
            }

            .btn-limpiar {
                background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
                color: white;
                border: none;
                border-radius: 10px;
                padding: 10px 20px;
                font-weight: 600;
                transition: all 0.3s ease;
            }

            .btn-limpiar:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 20px rgba(245, 87, 108, 0.3);
                color: white;
            }

            .results-counter {
                padding: 10px 15px;
                background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
                border-radius: 10px;
                font-size: 14px;
                color: #1565c0;
                display: inline-block;
            }

            /* Stats Cards */
            .stats-container {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 20px;
                margin-bottom: 30px;
            }

            .stat-card {
                background: white;
                border-radius: 15px;
                padding: 25px;
                box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
                transition: all 0.3s ease;
                animation: slideUp 0.6s ease-out;
                cursor: pointer;
            }

            .stat-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            }

            .stat-card.active {
                border: 2px solid #667eea;
                box-shadow: 0 10px 30px rgba(102, 126, 234, 0.2);
            }

            @keyframes slideUp {
                from {
                    opacity: 0;
                    transform: translateY(30px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .stat-icon {
                width: 50px;
                height: 50px;
                border-radius: 12px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 24px;
                color: white;
                margin-bottom: 15px;
            }

            .stat-icon.total {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            }

            .stat-icon.pending {
                background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            }

            .stat-icon.iniciada {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            }

            .stat-icon.completed {
                background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            }

            .stat-value {
                font-size: 32px;
                font-weight: 700;
                color: #2d3748;
                margin: 0;
            }

            .stat-label {
                color: #6c757d;
                font-size: 14px;
                margin: 0;
            }

            /* Task Card */
            .task-card {
                background: white;
                border-radius: 15px;
                padding: 20px;
                margin-bottom: 15px;
                box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
                transition: all 0.3s ease;
                animation: slideUp 0.6s ease-out;
                opacity: 0;
            }

            .task-card.visible {
                opacity: 1;
            }

            .task-card.hidden {
                display: none !important;
            }

            .task-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            }

            .task-header {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                margin-bottom: 15px;
            }

            .task-title {
                font-size: 18px;
                font-weight: 600;
                color: #2d3748;
                margin: 0 0 5px 0;
            }

            .task-description {
                color: #6c757d;
                font-size: 14px;
                margin: 0;
            }

            .task-badge {
                padding: 6px 12px;
                border-radius: 20px;
                font-size: 12px;
                font-weight: 600;
                cursor: pointer;
                user-select: none;
                transition: all 0.3s ease;
            }

            .task-badge:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            }

            .badge-iniciada {
                background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
                color: #1565c0;
            }

            .badge-pendiente {
                background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
                color: #e65100;
            }

            .badge-completada {
                background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
                color: #2e7d32;
            }

            /* Dropdown Styles */
            .dropdown-toggle::after {
                vertical-align: middle;
                margin-left: 5px;
            }

            .dropdown-menu {
                border-radius: 12px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
                border: none;
                padding: 8px;
                min-width: 180px;
            }

            .dropdown-item {
                border-radius: 8px;
                padding: 10px 15px;
                font-size: 14px;
                font-weight: 600;
                transition: all 0.3s ease;
                display: flex;
                align-items: center;
            }

            .dropdown-item:hover {
                background: #f8f9fa;
                transform: translateX(5px);
            }

            .dropdown-item:active {
                background: #e9ecef;
            }

            .dropdown-item i {
                font-size: 16px;
            }

            .task-footer {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-top: 15px;
                padding-top: 15px;
                border-top: 1px solid #e9ecef;
            }

            .task-date {
                color: #6c757d;
                font-size: 14px;
                display: flex;
                align-items: center;
                gap: 5px;
            }

            .task-actions {
                display: flex;
                gap: 8px;
            }

            .btn-action {
                width: 35px;
                height: 35px;
                border: none;
                border-radius: 8px;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.3s ease;
                cursor: pointer;
            }

            .btn-view {
                background: #e3f2fd;
                color: #1976d2;
            }

            .btn-view:hover {
                background: #1976d2;
                color: white;
            }

            .btn-edit {
                background: #fff3e0;
                color: #f57c00;
            }

            .btn-edit:hover {
                background: #f57c00;
                color: white;
            }

            .btn-delete {
                background: #ffebee;
                color: #d32f2f;
            }

            .btn-delete:hover {
                background: #d32f2f;
                color: white;
            }

            .empty-state {
                text-align: center;
                padding: 60px 20px;
                background: white;
                border-radius: 20px;
                box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
            }

            .empty-icon {
                font-size: 80px;
                color: #e9ecef;
                margin-bottom: 20px;
            }

            .empty-title {
                font-size: 24px;
                font-weight: 600;
                color: #2d3748;
                margin-bottom: 10px;
            }

            .empty-text {
                color: #6c757d;
                margin-bottom: 30px;
            }

            /* No Results State */
            .no-results-state {
                text-align: center;
                padding: 40px 20px;
                background: white;
                border-radius: 15px;
                box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
                display: none;
            }

            .no-results-state.visible {
                display: block;
            }

            .no-results-icon {
                font-size: 60px;
                color: #e9ecef;
                margin-bottom: 15px;
            }

            .no-results-title {
                font-size: 20px;
                font-weight: 600;
                color: #2d3748;
                margin-bottom: 10px;
            }

            .no-results-text {
                color: #6c757d;
            }

            /* Toast Notifications */
            .toast {
                min-width: 300px;
                border-radius: 12px;
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
                animation: slideInRight 0.4s ease-out;
            }
            
            @keyframes slideInRight {
                from {
                    opacity: 0;
                    transform: translateX(100%);
                }
                to {
                    opacity: 1;
                    transform: translateX(0);
                }
            }
            
            .toast.toast-success {
                background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            }
            
            .toast.toast-error {
                background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            }
            
            .toast.toast-info {
                background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            }
            
            .toast-body {
                padding: 15px 20px;
                font-size: 15px;
                font-weight: 500;
            }

            /* Estilos para el modal de detalle */
            .modal-content {
                border-radius: 15px;
                border: none;
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            }

            .modal-header {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border-radius: 15px 15px 0 0;
                padding: 20px 25px;
            }

            .modal-header .btn-close {
                filter: brightness(0) invert(1);
            }

            .modal-title {
                font-size: 20px;
            }

            .modal-body {
                padding: 25px;
            }

            #modal-estado-badge.badge-iniciada {
                background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
                color: #1565c0;
            }

            #modal-estado-badge.badge-pendiente {
                background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
                color: #e65100;
            }

            #modal-estado-badge.badge-completada {
                background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
                color: #2e7d32;
            }

            .timeline-container {
                position: relative;
            }

            .timeline-container::before {
                content: '';
                position: absolute;
                left: 5px;
                top: 12px;
                bottom: 12px;
                width: 2px;
                background: #e9ecef;
            }

            @media (max-width: 768px) {
                .task-header {
                    flex-direction: column;
                    gap: 10px;
                }

                .task-footer {
                    flex-direction: column;
                    gap: 10px;
                    align-items: flex-start;
                }

                .filters-container .row {
                    gap: 15px;
                }
            }
        </style>
    </head>
    <body>
        <!-- Navbar -->
        <nav class="navbar navbar-expand-lg navbar-custom">
            <div class="container-fluid px-4">
                <a class="navbar-brand" th:href="@{/dashboard}">
                    <div class="brand-icon">
                        <i class="bi bi-check2-circle"></i>
                    </div>
                    TaskFlow
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto align-items-center">
                        <li class="nav-item me-2">
                            <a th:href="@{/usuario/perfil}" class="user-badge">
                                <i class="bi bi-person-circle"></i>
                                <span th:text="${username}"></span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" th:href="@{/auth/logout}">
                                <i class="bi bi-box-arrow-right me-1"></i> Salir
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="main-content">
            <div class="container">
                <!-- Page Header -->
                <div class="page-header">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                        <div>
                            <h1 class="page-title">Mis Tareas</h1>
                            <p class="page-subtitle">Gestiona y organiza tus actividades</p>
                        </div>
                        <a th:href="@{/tareas/nueva}" class="btn-new-task">
                            <i class="bi bi-plus-circle"></i>
                            Nueva Tarea
                        </a>
                    </div>
                </div>

                <!-- Filtros y Ordenamiento -->
                <div class="filters-container mb-4">
                    <div class="row g-3 align-items-end">
                        <!-- Filtro por Estado -->
                        <div class="col-md-3 col-sm-6">
                            <label class="filter-label">
                                <i class="bi bi-funnel me-1"></i> Filtrar por Estado
                            </label>
                            <select id="filtro-estado" class="form-select filter-select">
                                <option value="TODOS">Todos los estados</option>
                                <option value="PENDIENTE">Pendiente</option>
                                <option value="INICIADA">Iniciada</option>
                                <option value="COMPLETADA">Completada</option>
                            </select>
                        </div>
                        
                        <!-- Ordenar por -->
                        <div class="col-md-3 col-sm-6">
                            <label class="filter-label">
                                <i class="bi bi-sort-down me-1"></i> Ordenar por
                            </label>
                            <select id="ordenar-por" class="form-select filter-select">
                                <option value="fecha-desc">Fecha (más reciente)</option>
                                <option value="fecha-asc">Fecha (más antigua)</option>
                            </select>
                        </div>
                        
                        <!-- Rango de Fechas -->
                        <div class="col-md-2 col-sm-6">
                            <label class="filter-label">
                                <i class="bi bi-calendar me-1"></i> Desde
                            </label>
                            <input type="date" id="fecha-desde" class="form-control filter-input">
                        </div>
                        
                        <div class="col-md-2 col-sm-6">
                            <label class="filter-label">
                                <i class="bi bi-calendar me-1"></i> Hasta
                            </label>
                            <input type="date" id="fecha-hasta" class="form-control filter-input">
                        </div>
                        
                        <!-- Botón Limpiar -->
                        <div class="col-md-2 col-sm-12">
                            <button type="button" id="btn-limpiar-filtros" class="btn btn-limpiar w-100">
                                <i class="bi bi-x-circle me-1"></i> Limpiar
                            </button>
                        </div>
                    </div>
                    
                    <!-- Contador de resultados -->
                    <div class="results-counter mt-3">
                        <span id="contador-resultados">
                            <i class="bi bi-list-ul me-1"></i>
                            Mostrando <strong id="num-mostradas">0</strong> de <strong id="num-total">0</strong> tareas
                        </span>
                    </div>
                </div>

                <!-- Stats -->
                <div class="stats-container">
                    <div class="stat-card" data-filter="TODOS" id="stat-total">
                        <div class="stat-icon total">
                            <i class="bi bi-list-task"></i>
                        </div>
                        <h3 class="stat-value" th:text="${tareas != null ? tareas.size() : 0}">0</h3>
                        <p class="stat-label">Total de Tareas</p>
                    </div>

                    <div class="stat-card" data-filter="PENDIENTE" id="stat-pendiente-card">
                        <div class="stat-icon pending">
                            <i class="bi bi-clock-history"></i>
                        </div>
                        <h3 class="stat-value" id="stat-pending">0</h3>
                        <p class="stat-label">Pendientes</p>
                    </div>

                    <div class="stat-card" data-filter="INICIADA" id="stat-iniciada-card">
                        <div class="stat-icon iniciada">
                            <i class="bi bi-hourglass-split"></i>
                        </div>
                        <h3 class="stat-value" id="stat-iniciada">0</h3>
                        <p class="stat-label">Iniciadas</p>
                    </div>

                    <div class="stat-card" data-filter="COMPLETADA" id="stat-completada-card">
                        <div class="stat-icon completed">
                            <i class="bi bi-check-circle"></i>
                        </div>
                        <h3 class="stat-value" id="stat-completed">0</h3>
                        <p class="stat-label">Completadas</p>
                    </div>
                </div>

                <!-- Tasks Container -->
                <div id="tasks-container">
                    <!-- Tasks List -->
                    <div th:if="${tareas != null and !tareas.isEmpty()}" id="tasks-list">
                        <div th:each="tarea, iterStat : ${tareas}" 
                             class="task-card" 
                             th:data-index="${iterStat.index}"
                             th:data-estado="${tarea.estado}"
                             th:data-fecha="${tarea.fechafin}"
                             th:data-titulo="${tarea.titulo}">
                            <div class="task-header">
                                <div>
                                    <h3 class="task-title" th:text="${tarea.titulo}">Título de la tarea</h3>
                                    <p class="task-description" th:text="${tarea.descripcion}">Descripción</p>
                                </div>
                                
                                <!-- Dropdown para cambiar estado -->
                                <div class="dropdown">
                                    <span class="task-badge dropdown-toggle" 
                                          th:classappend="${tarea.estado.toString() == 'INICIADA'} ? 'badge-iniciada' : 
                                          (${tarea.estado.toString() == 'PENDIENTE'} ? 'badge-pendiente' : 'badge-completada')"
                                          data-bs-toggle="dropdown"
                                          aria-expanded="false"
                                          th:data-id="${tarea.idTarea}"
                                          th:attr="data-estado-actual=${tarea.estado}">
                                        <span th:text="${tarea.estado}">Estado</span>
                                    </span>
                                    <ul class="dropdown-menu dropdown-menu-end">
                                        <li>
                                            <a class="dropdown-item cambiar-estado" 
                                               href="#"
                                               th:data-id="${tarea.idTarea}"
                                               data-estado="PENDIENTE">
                                                <i class="bi bi-clock me-2" style="color: #e65100;"></i>
                                                PENDIENTE
                                            </a>
                                        </li>
                                        <li>
                                            <a class="dropdown-item cambiar-estado" 
                                               href="#"
                                               th:data-id="${tarea.idTarea}"
                                               data-estado="INICIADA">
                                                <i class="bi bi-hourglass-split me-2" style="color: #1565c0;"></i>
                                                INICIADA
                                            </a>
                                        </li>
                                        <li>
                                            <a class="dropdown-item cambiar-estado" 
                                               href="#"
                                               th:data-id="${tarea.idTarea}"
                                               data-estado="COMPLETADA">
                                                <i class="bi bi-check-circle me-2" style="color: #2e7d32;"></i>
                                                COMPLETADA
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </div>

                            <div class="task-footer">
                                <div class="task-date">
                                    <i class="bi bi-calendar-event"></i>
                                    <span th:text="${tarea.fechafin}">Fecha</span>
                                </div>

                                <div class="task-actions">
                                    <button type="button" 
                                            class="btn-action btn-view btn-ver-detalle" 
                                            th:data-id="${tarea.idTarea}"
                                            th:data-titulo="${tarea.titulo}"
                                            th:data-descripcion="${tarea.descripcion}"
                                            th:data-estado="${tarea.estado}"
                                            th:data-fecha="${tarea.fechafin}"
                                            title="Ver detalle">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <a th:href="@{/tareas/editar/{id}(id=${tarea.idTarea})}" 
                                       class="btn-action btn-edit" 
                                       title="Editar">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    <form th:action="@{/tareas/eliminar/{id}(id=${tarea.idTarea})}" 
                                          method="post" 
                                          style="display: inline;"
                                          class="delete-form">
                                        <button type="submit" 
                                                class="btn-action btn-delete" 
                                                title="Eliminar"
                                                onclick="return confirm('¿Estás seguro de eliminar esta tarea?')">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!--  filtros sin resultado -->
                    <div class="no-results-state" id="no-results">
                        <div class="no-results-icon">
                            <i class="bi bi-search"></i>
                        </div>
                        <h2 class="no-results-title">Sin resultados</h2>
                        <p class="no-results-text">No se encontraron tareas con los filtros aplicados</p>
                        <button type="button" class="btn btn-limpiar mt-3" id="btn-limpiar-desde-empty">
                            <i class="bi bi-x-circle me-1"></i> Limpiar filtros
                        </button>
                    </div>

                    <!-- Empty State -->
                    <div th:if="${tareas == null or tareas.isEmpty()}" class="empty-state">
                        <div class="empty-icon">
                            <i class="bi bi-clipboard-x"></i>
                        </div>
                        <h2 class="empty-title">No tienes tareas</h2>
                        <p class="empty-text">Comienza creando tu primera tarea y organiza tu día</p>
                        <a th:href="@{/tareas/nueva}" class="btn-new-task">
                            <i class="bi bi-plus-circle"></i>
                            Crear Primera Tarea
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal de Detalle de Tarea -->
        <div class="modal fade" id="detalleModal" tabindex="-1" aria-labelledby="detalleModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content">
                    <div class="modal-header border-0">
                        <h5 class="modal-title fw-bold" id="detalleModalLabel">
                            <i class="bi bi-info-circle me-2"></i>
                            Detalle de Tarea
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Título -->
                        <div class="mb-4">
                            <h3 class="fw-bold text-dark mb-2" id="modal-titulo">Título de la tarea</h3>
                            <span class="badge rounded-pill fs-6 px-3 py-2" id="modal-estado-badge">
                                <i class="bi bi-clock-fill me-1"></i>
                                <span id="modal-estado">PENDIENTE</span>
                            </span>
                        </div>

                        <!-- Info Cards -->
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <div class="p-3 bg-light rounded-3">
                                    <div class="d-flex align-items-center mb-2">
                                        <div class="rounded-circle bg-success bg-opacity-10 p-2 me-2">
                                            <i class="bi bi-calendar-event text-success"></i>
                                        </div>
                                        <small class="text-muted text-uppercase">Fecha Fin</small>
                                    </div>
                                    <p class="fw-semibold mb-0" id="modal-fecha">01/01/2024</p>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="p-3 bg-light rounded-3">
                                    <div class="d-flex align-items-center mb-2">
                                        <div class="rounded-circle bg-warning bg-opacity-10 p-2 me-2">
                                            <i class="bi bi-flag-fill text-warning"></i>
                                        </div>
                                        <small class="text-muted text-uppercase">Estado</small>
                                    </div>
                                    <p class="fw-semibold mb-0" id="modal-estado-text">PENDIENTE</p>
                                </div>
                            </div>
                        </div>

                        <!-- Descripción -->
                        <div class="mb-4">
                            <h6 class="fw-semibold mb-2">
                                <i class="bi bi-text-paragraph me-2"></i>
                                Descripción
                            </h6>
                            <div class="p-3 bg-light rounded-3">
                                <p class="mb-0 text-muted" id="modal-descripcion">
                                    Sin descripción
                                </p>
                            </div>
                        </div>

                        <!-- Timeline -->
                        <div class="mb-3">
                            <h6 class="fw-semibold mb-3">
                                <i class="bi bi-clock-history me-2"></i>
                                Información Adicional
                            </h6>
                            <div class="timeline-container">
                                <div class="d-flex mb-3">
                                    <div class="me-3">
                                        <div class="rounded-circle bg-primary" style="width: 12px; height: 12px; margin-top: 4px;"></div>
                                    </div>
                                    <div class="flex-grow-1">
                                        <p class="fw-semibold mb-1">Fecha límite</p>
                                        <p class="text-muted small mb-0" id="modal-fecha-limite">
                                            Completar antes del 01/01/2024
                                        </p>
                                    </div>
                                </div>

                                <div class="d-flex" id="modal-estado-timeline">
                                    <div class="me-3">
                                        <div class="rounded-circle" style="width: 12px; height: 12px; margin-top: 4px;" id="timeline-dot"></div>
                                    </div>
                                    <div class="flex-grow-1">
                                        <p class="fw-semibold mb-1">Estado</p>
                                        <p class="small mb-0" id="modal-estado-mensaje">
                                            <i class="bi bi-hourglass-split me-1"></i>
                                            Tarea pendiente de completar
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer border-0 pt-0">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle me-1"></i>
                            Cerrar
                        </button>
                        <button type="button" class="btn btn-primary" id="btn-editar-modal">
                            <i class="bi bi-pencil me-1"></i>
                            Editar
                        </button>
                        <button type="button" class="btn btn-danger" id="btn-eliminar-modal">
                            <i class="bi bi-trash me-1"></i>
                            Eliminar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Toast Container -->
        <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;">
            <div id="successToast" class="toast align-items-center text-white border-0" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="bi bi-check-circle-fill me-2"></i>
                        <span id="toastMessage"></span>
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        </div>

        <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script th:inline="javascript">
            $(document).ready(function () {
                function showToast(message, type = 'success') {
                    const toast = $('#successToast');
                    const toastBody = toast.find('.toast-body');
                    
                    toast.removeClass('toast-success toast-error toast-info');
                    
                    if (type === 'success') {
                        toast.addClass('toast-success');
                        toastBody.html('<i class="bi bi-check-circle-fill me-2"></i><span>' + message + '</span>');
                    } else if (type === 'error') {
                        toast.addClass('toast-error');
                        toastBody.html('<i class="bi bi-exclamation-circle-fill me-2"></i><span>' + message + '</span>');
                    } else if (type === 'info') {
                        toast.addClass('toast-info');
                        toastBody.html('<i class="bi bi-info-circle-fill me-2"></i><span>' + message + '</span>');
                    }
                    
                    const bsToast = new bootstrap.Toast(toast[0], {
                        autohide: true,
                        delay: 4000
                    });
                    bsToast.show();
                }
                
                const successMsg = /*[[${success}]]*/ null;
                const errorMsg = /*[[${error}]]*/ null;
                const infoMsg = /*[[${info}]]*/ null;
                
                if (successMsg) {
                    showToast(successMsg, 'success');
                }
                if (errorMsg) {
                    showToast(errorMsg, 'error');
                }
                if (infoMsg) {
                    showToast(infoMsg, 'info');
                }
                
                $('.task-card').each(function (index) {
                    $(this).delay(index * 100).animate({'opacity': '1'}, 400);
                    $(this).addClass('visible');
                });

                // FILTRADO Y ORDENAMIENTO

                function parseFecha(fechaStr) {
                    if (!fechaStr) return null;
                    
                    if (fechaStr.includes('/')) {
                        const parts = fechaStr.split('/');
                        if (parts.length === 3) {
                            return new Date(parts[2], parts[1] - 1, parts[0]);
                        }
                    }
                    if (fechaStr.includes('-')) {
                        return new Date(fechaStr);
                    }
                    return null;
                }

                // Función para obtener el orden del estado
                function getEstadoOrden(estado) {
                    const orden = {
                        'PENDIENTE': 1,
                        'INICIADA': 2,
                        'COMPLETADA': 3
                    };
                    return orden[estado] || 99;
                }

                function aplicarFiltrosYOrden() {
                    const filtroEstado = $('#filtro-estado').val();
                    const ordenarPor = $('#ordenar-por').val();
                    const fechaDesde = $('#fecha-desde').val();
                    const fechaHasta = $('#fecha-hasta').val();

                    const fechaDesdeDate = fechaDesde ? new Date(fechaDesde) : null;
                    const fechaHastaDate = fechaHasta ? new Date(fechaHasta + 'T23:59:59') : null;

                    let tareasVisibles = [];
                    let totalTareas = 0;

                    // Filtrar tareas
                    $('.task-card').each(function() {
                        const card = $(this);
                        const estado = card.find('.task-badge span').text().trim();
                        const fechaStr = card.data('fecha');
                        const fecha = parseFecha(fechaStr);
                        
                        totalTareas++;
                        let mostrar = true;

                        // Filtro por estado
                        if (filtroEstado !== 'TODOS' && estado !== filtroEstado) {
                            mostrar = false;
                        }

                        // Filtro por fecha desde
                        if (mostrar && fechaDesdeDate && fecha) {
                            if (fecha < fechaDesdeDate) {
                                mostrar = false;
                            }
                        }

                        // Filtro por fecha hasta
                        if (mostrar && fechaHastaDate && fecha) {
                            if (fecha > fechaHastaDate) {
                                mostrar = false;
                            }
                        }

                        if (mostrar) {
                            card.removeClass('hidden');
                            tareasVisibles.push({
                                element: card,
                                estado: estado,
                                fecha: fecha,
                                titulo: card.data('titulo') || card.find('.task-title').text()
                            });
                        } else {
                            card.addClass('hidden');
                        }
                    });

                    // Ordenar tareas
                    tareasVisibles.sort((a, b) => {
                        switch (ordenarPor) {
                            case 'fecha-desc':
                                if (!a.fecha && !b.fecha) return 0;
                                if (!a.fecha) return 1;
                                if (!b.fecha) return -1;
                                return b.fecha - a.fecha;
                            
                            case 'fecha-asc':
                                if (!a.fecha && !b.fecha) return 0;
                                if (!a.fecha) return 1;
                                if (!b.fecha) return -1;
                                return a.fecha - b.fecha;
                            
                            
                            case 'estado':
                                return getEstadoOrden(a.estado) - getEstadoOrden(b.estado);
                            
                            default:
                                return 0;
                        }
                    });

                    const container = $('#tasks-list');
                    tareasVisibles.forEach((tarea, index) => {
                        tarea.element.css('animation-delay', (index * 0.05) + 's');
                        container.append(tarea.element);
                    });

                    // Actualizar contador
                    $('#num-mostradas').text(tareasVisibles.length);
                    $('#num-total').text(totalTareas);

                    // Mostrar/ocultar mensaje de sin resultados
                    if (tareasVisibles.length === 0 && totalTareas > 0) {
                        $('#no-results').addClass('visible');
                    } else {
                        $('#no-results').removeClass('visible');
                    }

                    // Resaltar stat card activo
                    $('.stat-card').removeClass('active');
                    if (filtroEstado !== 'TODOS') {
                        $(`.stat-card[data-filter="${filtroEstado}"]`).addClass('active');
                    }
                }

                // Actualizar estadísticas
                function actualizarEstadisticas() {
                    let pending = 0;
                    let iniciada = 0;
                    let completed = 0;

                    $('.task-card').each(function () {
                        const estado = $(this).find('.task-badge span').text().trim();
                        if (estado === 'PENDIENTE') {
                            pending++;
                        } else if (estado === 'INICIADA') {
                            iniciada++;
                        } else if (estado === 'COMPLETADA') {
                            completed++;
                        }
                    });

                    $('#stat-pending').text(pending);
                    $('#stat-iniciada').text(iniciada);
                    $('#stat-completed').text(completed);

                    // Actualizar contador total
                    const total = $('.task-card').length;
                    $('#num-total').text(total);
                }

                // Limpiar filtros
                function limpiarFiltros() {
                    $('#filtro-estado').val('TODOS');
                    $('#ordenar-por').val('fecha-desc');
                    $('#fecha-desde').val('');
                    $('#fecha-hasta').val('');
                    
                    aplicarFiltrosYOrden();
                    showToast('Filtros limpiados', 'info');
                }

                // Event listeners para filtros
                $('#filtro-estado, #ordenar-por, #fecha-desde, #fecha-hasta').on('change', function() {
                    aplicarFiltrosYOrden();
                });

                $('#btn-limpiar-filtros, #btn-limpiar-desde-empty').on('click', limpiarFiltros);

                $('.stat-card').on('click', function() {
                    const filtro = $(this).data('filter');
                    $('#filtro-estado').val(filtro);
                    aplicarFiltrosYOrden();
                });

                // Inicializar
                actualizarEstadisticas();
                aplicarFiltrosYOrden();

                // CAMBIO DE ESTADO 

                const token = /*[[${session.token}]]*/ '';
                const idUsuario = /*[[${session.idUsuario}]]*/ '';

                function limpiarDropdowns() {
                    $('.dropdown-menu').removeClass('show');
                    $('.dropdown').removeClass('show');
                    $('.task-badge').attr('aria-expanded', 'false');
                    
                    $('.dropdown-backdrop').remove();
                    $('body').removeClass('dropdown-open');
                    
                    $('.task-badge').each(function() {
                        const instance = bootstrap.Dropdown.getInstance(this);
                        if (instance) {
                            instance.dispose();
                        }
                    });
                    
                    $('.task-badge').each(function() {
                        new bootstrap.Dropdown(this);
                    });
                }

                $(document).on('click', '.cambiar-estado', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const idTarea = $(this).data('id');
                    const nuevoEstado = $(this).data('estado');
                    const dropdownElement = $(this).closest('.dropdown');
                    const badge = dropdownElement.find('.task-badge');
                    const taskCard = badge.closest('.task-card');
                    
                    const estadoActual = badge.attr('data-estado-actual');
                    
                    if (nuevoEstado === estadoActual) {
                        limpiarDropdowns();
                        return;
                    }
                    
                    limpiarDropdowns();
                    
                    $.ajax({
                        url: `http://localhost:8080/api/tareas/usuario/${idUsuario}/${idTarea}/estado`,
                        type: 'PATCH',
                        contentType: 'application/json',
                        headers: {
                            'Authorization': 'Bearer ' + token
                        },
                        data: JSON.stringify({ estado: nuevoEstado }),
                        success: function(response) {
                            if (response.correct || response.status === 200) {
                                showToast('Estado actualizado a ' + nuevoEstado, 'success');
                                
                                badge.removeClass('badge-iniciada badge-pendiente badge-completada');
                                
                                badge.attr('data-estado-actual', nuevoEstado);
                                badge.data('estado-actual', nuevoEstado);
                                
                                badge.find('span').text(nuevoEstado);
                                
                                // Actualizar data-estado en la tarjeta
                                taskCard.attr('data-estado', nuevoEstado);
                                taskCard.data('estado', nuevoEstado);
                                
                                if (nuevoEstado === 'INICIADA') {
                                    badge.addClass('badge-iniciada');
                                } else if (nuevoEstado === 'PENDIENTE') {
                                    badge.addClass('badge-pendiente');
                                } else if (nuevoEstado === 'COMPLETADA') {
                                    badge.addClass('badge-completada');
                                }
                                
                                taskCard.find('.btn-ver-detalle').attr('data-estado', nuevoEstado);
                                
                                actualizarEstadisticas();
                                aplicarFiltrosYOrden(); // Re-aplicar filtros después de cambio
                                
                                setTimeout(function() {
                                    limpiarDropdowns();
                                }, 200);
                                
                            } else {
                                showToast(response.errorMessage || 'Error al actualizar el estado', 'error');
                                limpiarDropdowns();
                            }
                        },
                        error: function(xhr, status, error) {
                            let errorMessage = 'Error al actualizar el estado';
                            
                            if (xhr.responseJSON && xhr.responseJSON.errorMessage) {
                                errorMessage = xhr.responseJSON.errorMessage;
                            } else if (xhr.status === 404) {
                                errorMessage = 'Tarea no encontrada';
                            } else if (xhr.status === 403) {
                                errorMessage = 'No tienes permisos para realizar esta acción';
                            } else if (xhr.status === 401) {
                                errorMessage = 'Sesión expirada. Inicia sesión nuevamente';
                                setTimeout(() => {
                                    window.location.href = '/auth/login';
                                }, 2000);
                            }
                            
                            showToast(errorMessage, 'error');
                            limpiarDropdowns();
                        }
                    });
                });

                setTimeout(function() {
                    $('.task-badge').each(function() {
                        new bootstrap.Dropdown(this);
                    });
                }, 100);

                $(document).on('click', function(e) {
                    if (!$(e.target).closest('.dropdown').length && !$(e.target).hasClass('cambiar-estado')) {
                        limpiarDropdowns();
                    }
                });

                $(document).on('click', '.task-badge', function(e) {
                    if ($(this).attr('aria-expanded') === 'true') {
                        e.stopPropagation();
                    }
                });

                // MODAL DE DETALLE 
                

                $(document).on('click', '.btn-ver-detalle', function () {
                    const id = $(this).data('id');
                    const titulo = $(this).data('titulo');
                    let descripcion = $(this).data('descripcion');
                    const taskCard = $(this).closest('.task-card');
                    const estado = taskCard.find('.task-badge span').text().trim();
                    const fecha = $(this).data('fecha');

                    if (!descripcion || descripcion === 'null' || descripcion.trim() === '') {
                        descripcion = 'Sin descripción';
                    }

                    $('#modal-titulo').text(titulo);
                    $('#modal-fecha').text(fecha);
                    $('#modal-descripcion').text(descripcion);
                    $('#modal-estado').text(estado);
                    $('#modal-estado-text').text(estado);
                    $('#modal-fecha-limite').text('Completar antes del ' + fecha);

                    const badge = $('#modal-estado-badge');
                    badge.removeClass('badge-iniciada badge-pendiente badge-completada');

                    if (estado === 'INICIADA') {
                        badge.addClass('badge-iniciada');
                        badge.find('i').attr('class', 'bi bi-clock-fill me-1');
                    } else if (estado === 'PENDIENTE') {
                        badge.addClass('badge-pendiente');
                        badge.find('i').attr('class', 'bi bi-clock-fill me-1');
                    } else if (estado === 'COMPLETADA') {
                        badge.addClass('badge-completada');
                        badge.find('i').attr('class', 'bi bi-check-circle-fill me-1');
                    }

                    const timelineDot = $('#timeline-dot');
                    const estadoMensaje = $('#modal-estado-mensaje');

                    if (estado === 'COMPLETADA') {
                        timelineDot.removeClass('bg-warning').addClass('bg-success');
                        estadoMensaje.html('<i class="bi bi-check-circle-fill text-success me-1"></i> Tarea completada exitosamente');
                        estadoMensaje.removeClass('text-muted').addClass('text-success');
                    } else {
                        timelineDot.removeClass('bg-success').addClass('bg-warning');
                        estadoMensaje.html('<i class="bi bi-hourglass-split text-warning me-1"></i> Tarea pendiente de completar');
                        estadoMensaje.removeClass('text-success').addClass('text-muted');
                    }

                    $('#btn-editar-modal').off('click').on('click', function () {
                        window.location.href = '/tareas/editar/' + id;
                    });

                    $('#btn-eliminar-modal').off('click').on('click', function () {
                        if (confirm('¿Estás seguro de eliminar esta tarea?')) {
                            const form = $('<form>', {
                                'method': 'POST',
                                'action': '/tareas/eliminar/' + id
                            });
                            $('body').append(form);
                            form.submit();
                        }
                    });

                    $('#detalleModal').modal('show');
                });
            });
        </script>
    </body>
</html>